<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Forum</title>
	<style>
	    body {
	        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
	        margin: 0;
	        padding: 0;
	        background-color: #2b2b2b; /* 深灰背景，不是純黑 */
	        color: #f0f0f0; /* 亮色文字 */
	    }
	    .comment {
	        margin-bottom: 10px;
	        border: 1px solid #3d3d3d; /* 略深邊框 */
	        padding: 10px;
	        background-color: #333; /* 深色背景 */
	        border-radius: 8px; /* 圓角邊框 */
	        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* 輕微陰影 */
	    }
	    .reply-form {
	        margin-top: 10px;
	        margin-left: 30px;
	    }
	    #new-discussion-button {
	        display: block;
	        margin: 20px auto;
	        padding: 10px 20px;
	        background-color: #4a4a4a; /* 深灰按鈕 */
	        color: white;
	        border: none;
	        border-radius: 5px;
	        cursor: pointer;
	        transition: background-color 0.3s; /* 漸變效果 */
	    }
	    #new-discussion-button:hover {
	        background-color: #5a5a5a; /* 滑鼠懸停時變色 */
	    }
	    .replies {
	        margin-left: 20px;
	    }
	
	    /* 輸入框和按鈕的樣式 */
	    input[type="text"], textarea {
	        width: 100%; /* 全寬 */
	        padding: 8px;
	        margin: 6px 0;
	        display: inline-block;
	        border: 1px solid #ccc;
	        border-radius: 4px;
	        box-sizing: border-box;
	        background-color: #f0f0f0; /* 淺色背景 */
	        color: #333; /* 深色文字 */
	    }
	
	    input[type="submit"] {
	        width: 100%;
	        background-color: #4a4a4a;
	        color: white;
	        padding: 14px 20px;
	        margin: 8px 0;
	        border: none;
	        border-radius: 4px;
	        cursor: pointer;
	    }
	
	    input[type="submit"]:hover {
	        background-color: #5a5a5a;
	    }
	</style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <h1>Forum</h1>
    <button id="view-all-articles-button">檢視所有文章</button>
	<div id="articles-list" style="margin-top: 20px;"></div>
    <button id="new-discussion-button">新增討論</button>

    <div id="comments">
		
    </div>

    <script>
        let replyFormIdCounter = 0;

        // 函數用於顯示/隱藏回覆表單
        function toggleReplyForm(commentId) {
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            if (replyForm) {
                replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
            }
        }

        // 為回覆按鈕添加點擊事件監聽器
        function addReplyButtonListener(button) {
            button.addEventListener('click', function() {
                const commentId = this.getAttribute('data-comment-id');
                toggleReplyForm(commentId);
            });
        }

        // 函數用於處理回覆表單的提交
        function handleReplyFormSubmit(event) {
            event.preventDefault(); // 阻止表單的默認提交行為

            const form = event.target;
            const username = form.querySelector('input[name="reply-username"]').value;
            const comment = form.querySelector('textarea[name="reply-comment"]').value;

            if (username.trim() === '' || comment.trim() === '') {
                alert('用戶名稱和回覆內容不能為空！');
                return;
            }

            const repliesContainer = form.closest('.comment').querySelector('.replies') || createRepliesContainer(form.closest('.comment'));
            const newReplyDiv = document.createElement('div');
            newReplyDiv.classList.add('comment');
            newReplyDiv.innerHTML = `<p>${username}的回覆：${comment}</p>`;

            repliesContainer.appendChild(newReplyDiv);

            form.reset();
        }

        function createRepliesContainer(commentDiv) {
            const repliesDiv = document.createElement('div');
            repliesDiv.classList.add('replies');
            commentDiv.appendChild(repliesDiv);
            return repliesDiv;
        }

        // 新增討論按鈕的點擊事件
        document.getElementById('new-discussion-button').addEventListener('click', function() {
            const title = prompt('Please insert title：');
            if (title !== null && title.trim() !== '') {
                const content = prompt('Please insert content：');
                if (content !== null && content.trim() !== '') {
                    addNewDiscussion(title, content);
                    alert("postArticle");
                    postArticle(title,content);
                }
            }
        });

        function addNewDiscussion(title, content) {
            const commentsSection = document.getElementById('comments');
            const newDiscussionDiv = document.createElement('div');
            newDiscussionDiv.classList.add('comment');
            const commentId = `comment-${++replyFormIdCounter}`;
            newDiscussionDiv.innerHTML = `
                <h3>${title}</h3>
                <p>${content}</p>
                <button class="reply-button" data-comment-id="${commentId}">回覆</button>
                <div class="reply-form" id="reply-form-${commentId}" style="display: none;">
                    <form>
                        <div>
                            <label for="reply-username-${commentId}">用戶名稱：</label>
                            <input type="text" id="reply-username-${commentId}" name="reply-username" required>
                        </div>
                        <div>
                            <label for="reply-comment-${commentId}">回覆內容：</label>
                            <textarea id="reply-comment-${commentId}" name="reply-comment" rows="3" cols="40" required></textarea>
                        </div>
                        <div>
                            <input type="submit" value="提交回覆">
                        </div>
                    </form>
                </div>`;
            commentsSection.appendChild(newDiscussionDiv);

            // 為新增的回覆按鈕添加事件監聽器
            const newReplyButton = newDiscussionDiv.querySelector('.reply-button');
            addReplyButtonListener(newReplyButton);

            // 為新增的回覆表單添加提交事件監聽器
            const newForm = newDiscussionDiv.querySelector('.reply-form form');
            newForm.addEventListener('submit', handleReplyFormSubmit);
        }
		
		
        // 為所有現有的回覆按鈕添加事件監聽器
        const replyButtons = document.querySelectorAll('.reply-button');
        replyButtons.forEach(addReplyButtonListener);

        // 為所有現有的回覆表單添加提交事件監聽器
        const replyForms = document.querySelectorAll('.reply-form form');
        replyForms.forEach(form => {
            form.addEventListener('submit', handleReplyFormSubmit);
        });
		
        
        function init() {
            // 為所有現有的回覆按鈕添加事件監聽器
            const replyButtons = document.querySelectorAll('.reply-button');
            replyButtons.forEach(addReplyButtonListener);

            // 為所有現有的回覆表單添加提交事件監聽器
            const replyForms = document.querySelectorAll('.reply-form form');
            replyForms.forEach(form => {
                form.addEventListener('submit', handleReplyFormSubmit);
            });

            // 為檢視所有文章按鈕添加事件監聽器
            document.getElementById('view-all-articles-button').addEventListener('click', getArticle);
        }

        // 呼叫初始化函數
        init();
        
		function getArticle() {
		    console.log("Attempting to get articles..."); // Debugging line
		
		    $.ajax({
		        type: "GET",
		        url: "/SA_test/api/article.do",
		        dataType: 'json',
		        success: function(response) {
			    console.log("Response from server:", response); // Debugging line
			
			    const articlesListDiv = document.getElementById('articles-list');
			    if (response && response.response && Array.isArray(response.response.data)) {
			        console.log("Displaying articles..."); // Debugging line
			        articlesListDiv.innerHTML = ''; // Clear existing articles
			
			        // Use the correct data property that was validated to be an array
			        response.response.data.forEach(function(article) {
			            const articleDiv = document.createElement('div');
			            articleDiv.classList.add('comment'); // Add class for styling
			            articleDiv.innerHTML = `
			                <h3>${article.title}</h3>
			                <p>${article.article_content}</p>
			                <span>Posted on: ${new Date(article.article_time).toLocaleString()}</span>
			            `;
			            articlesListDiv.appendChild(articleDiv);
			        });
			    } else {
			        console.error("Error: 'data' is not an array", response.response && response.response.data); // Debugging line
			    }
			},
		        error: function(jqXHR, textStatus, errorThrown) {
		            console.error("AJAX error:", textStatus, errorThrown); // Debugging line
		            alert("無法連線到伺服器！");
		        }
		    });
		}
         function postArticle(title, content) {
            var url = new URL(window.location.href);
            var id = url.searchParams.get("id");
            var data = {
                title: title,
                content: content,
                member_id: id
            };
			console.log("ID:", id);
            $.ajax({
                type: "POST",
                url: "api/article.do",
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if(response.status == 200){
                        // 處理成功的情況
                    }
                    console.log(response);
                },
                error: function() {
                    alert("Error posting article");
                }
            });
        }
		// 函數用於處理回覆表單的提交
    function handleReplyFormSubmit(event) {
        event.preventDefault();

		var data = {
            message_content: article_content,
            message_time: message_time,
            article_id: article_id,
            member_id: id
        };

        if (comment.trim() === '') {
            alert('回覆內容不能為空！');
            return;
        }

        // 調用 postMessage 函數來提交回覆
        postMessage(comment, article_id);
    }

    // 函數用於提交回覆到服務器
    function postMessage(comment, article_id) {
        $.ajax({
            type: "POST",
            url: "/SA_test/api/message.do", 
            contentType: 'application/json',
            data: JSON.stringify({
                comment: comment,
                article_id: article_id
            }),
            success: function(response) {
                // 處理成功的情況，例如：更新前端界面
                alert('回覆已成功提交！');
            },
            error: function() {
                // 處理錯誤的情況
                alert('提交回覆時發生錯誤！');
            }
        });
    }

    </script>
</body>
</html>